package com.kevlanche.beaversmustdie;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.InputAdapter;
import com.badlogic.gdx.Screen;
import com.badlogic.gdx.graphics.GL10;
import com.badlogic.gdx.math.MathUtils;
import com.badlogic.gdx.math.Vector2;
import com.badlogic.gdx.physics.box2d.World;
import com.badlogic.gdx.scenes.scene2d.Stage;
import com.badlogic.gdx.utils.Array;
import com.badlogic.gdx.utils.Disposable;
import com.kevlanche.beaversmustdie.Shark.SharkSweetAirJumpTimeReportReceiver;

public class GameScreen extends InputAdapter implements Screen{

	private Array<Disposable> disposables;

	private float zoom;
	private Stage gameStage, gui;

	private Shark shark;
	
	private World physicsWorld;
	float physicsTimeBuffer;
	
	public GameScreen() {
	
		disposables = new Array<Disposable>();
		
		gameStage = new Stage();
		gui = new Stage();
		disposables.add(gameStage);
		disposables.add(gui);
		
		physicsWorld = new World(Vector2.Zero, false);
		
		
		Water water = new Water(physicsWorld);
		gameStage.addActor(water);
		disposables.add(water);
		

		final LBL sharkTimeLbl = new LBL("No jump yet!", 2.0f);
		sharkTimeLbl.position(Mane.WIDTH*0.05f, Mane.HEIGHT - Mane.WIDTH*0.05f, 0.0f, 1.0f);
		
		gui.addActor(sharkTimeLbl);
		
		shark = new Shark(physicsWorld, new SharkSweetAirJumpTimeReportReceiver() {
			
			@Override
			public void onSharkIsDoingSweetJumpFor(float duration) {
				String format = Float.toString(duration);
				if (format.length() > 5) format = format.substring(0, 4);
				sharkTimeLbl.setText( ""+format );
			}
			
			@Override
			public void onSharkDidSweetJumpFor(float duration) {
				String format = Float.toString(duration);
				if (format.length() > 5) format = format.substring(0, 4);
				sharkTimeLbl.setText( format +"!");
			}
		});
		gameStage.addActor(shark);
		gameStage.addActor(new Island(physicsWorld, 180.0f, 5.0f));
		
		if (Mane.PHYSICS_DEBUG)
			gameStage.addActor(new Box2dDebug(physicsWorld));
		
		zoom = 1.0f;
	}
	
	private static final float TIME_STEP = 1.0f / 60.0f;
	
	@Override
	public void render(float delta) {
		Gdx.gl.glClearColor(0, 0, 0, 1);
		Gdx.gl.glClear(GL10.GL_COLOR_BUFFER_BIT);
		
		physicsTimeBuffer += delta;
		
		while (physicsTimeBuffer >= TIME_STEP ) {
			physicsTimeBuffer -= TIME_STEP;
			physicsWorld.step(TIME_STEP, 4, 4);
		}
		
		gameStage.act(delta);
		gameStage.setViewport(Mane.WIDTH/zoom, Mane.HEIGHT/zoom, true);
		gameStage.getCamera().translate(-Mane.WIDTH/(2*zoom) + shark.getX() + shark.getWidth()/2, 
									-Mane.HEIGHT/(2*zoom) + shark.getY() + shark.getHeight()/2, 0.0f);
		
		if (!Mane.PHYSICS_DEBUG) {
			float sharkAng = shark.getRotation() + 90.0f;
			gameStage.getCamera().up.set( MathUtils.cosDeg(sharkAng), MathUtils.sinDeg(sharkAng), 0.0f);
		}
		gameStage.draw();
		
		gui.draw();
	}

	@Override
	public void resize(int width, int height) {
		gameStage.setViewport(Mane.WIDTH, Mane.HEIGHT, true);
		gui.setViewport(Mane.WIDTH, Mane.HEIGHT, true);
//		stage.getCamera().translate(-stage.getGutterWidth(),
//		    -stage.getGutterHeight(), 0);
	}

	@Override
	public void show() {
		Gdx.input.setInputProcessor(this);
	}

	@Override
	public void hide() {
		if (Gdx.input.getInputProcessor() == this)
			Gdx.input.setInputProcessor(null);
	}

	@Override
	public void pause() {
		
	}

	@Override
	public void resume() {
		
	}

	@Override
	public void dispose() {
		for (Disposable d : disposables) {
			d.dispose();
		}
		disposables.clear();
		
	}

	@Override
	public boolean scrolled(int amount) {
		
		zoom = MathUtils.clamp(zoom - amount*0.1f, 0.25f, 2.5f);
		return true;
	}
	

}
