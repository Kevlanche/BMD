package com.kevlanche.beaversmustdie;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.graphics.GL20;
import com.badlogic.gdx.graphics.Mesh;
import com.badlogic.gdx.graphics.VertexAttribute;
import com.badlogic.gdx.graphics.g2d.SpriteBatch;
import com.badlogic.gdx.graphics.glutils.ShaderProgram;
import com.badlogic.gdx.math.MathUtils;
import com.badlogic.gdx.scenes.scene2d.Actor;
import com.badlogic.gdx.utils.Disposable;

public class Water extends Actor implements Disposable {
	
	float time;
	ShaderProgram shader;
	Mesh mesh;
	
	public Water() {
		
shader = new ShaderProgram(getFile("vert.vs"), getFile("frag.fs"));
		
		if (!shader.isCompiled()) {
			System.err.println("SHADER NOT COMPILED");
			System.out.println(shader.getLog());
		}
		
		int i;
		final int triangles = 15; // 15 + (int)(10*MathUtils.cos(time)); // number of triangles
	 

		
		float[] tris = new float[3*(triangles + 2)];
//		short[] indices = new short[3*(triangles+2)];
		
		tris[0] = 0.0f;
		tris[1] = 0.0f;
		tris[2] = 0.0f;
//		indices[1] = 1;
//		indices[2] = 2;
		
		for(i = 0; i <= triangles; i++) { 

			tris[3*(i+1) + 0] = 0.5f * MathUtils.cos(i *  MathUtils.PI2 / triangles);
			tris[3*(i+1) + 1] = 0.5f * MathUtils.sin(i *  MathUtils.PI2 / triangles);
			tris[3*(i+1) + 2] = 0.0f;
			
//			indices[3*(i+1) + 1] = (short)i;//(short)(3*(i+1));
//			indices[3*(i+1) + 2] = (short)(i+1);//(short)(3*(i+1) + 1);
			
		}
		mesh = new Mesh(true, tris.length, 0, VertexAttribute.Position());
		mesh.setVertices(tris);
//		mesh.setIndices(indices);
		
	}
	
	public void act(float dt) {
		super.act(dt);
		this.time += dt;
	}
	
	private String getFile(String file) {
		return Gdx.files.internal("data/"+file).readString();
	}
	
	@Override
	public void draw(SpriteBatch batch, float parentAlpha) {

		shader.begin();
		
		shader.setUniformMatrix("u_worldView", batch.getProjectionMatrix());
		shader.setUniformf("time", time);
		shader.setUniformf("size", 1000.0f);
		
		mesh.render(shader, GL20.GL_TRIANGLE_FAN);
		
		shader.end();
		
		batch.end();
		batch.begin();
		
	}

	@Override
	public void dispose() {
		mesh.dispose();
		shader.dispose();
	}
}

